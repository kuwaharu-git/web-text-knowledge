# Difyナレッジファイル生成システム 要件定義書

## 1. プロジェクト概要

### 1.1 システム名
Difyナレッジファイル生成システム（Dify Knowledge File Generator）

### 1.2 目的
指定されたWebサイトURLから自動的にテキストコンテンツを収集し、Difyのナレッジベースに最適化されたファイル（.txt、.md、.docx形式）を生成するシステムを開発する。

### 1.3 対象範囲
- Webサイトのスクレイピング機能
- Dify向けテキスト抽出・整形機能
- Dify互換ナレッジファイル生成機能
- 設定可能なクロール深度とページ数制限
- Difyでの読み込み最適化機能

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 Webスクレイピング機能
- **F001**: 指定されたURLからWebページを取得する
- **F002**: HTML構造を解析し、テキストコンテンツを抽出する
- **F003**: 画像のalt属性、title属性も含めてテキスト情報を収集する
- **F004**: リンクを辿って関連ページを取得する

#### 2.1.2 クロール制御機能
- **F005**: クロール深度を指定可能（1〜10レベル）
- **F006**: 取得ページ数の上限を設定可能（1〜1000ページ）
- **F007**: 同一ドメイン内でのクロール制限機能
- **F008**: robots.txtの遵守機能
- **F009**: リクエスト間隔の制御（礼儀正しいクロール）

#### 2.1.3 テキスト処理機能
- **F010**: HTMLタグの除去とテキスト抽出
- **F011**: 文字エンコーディングの自動判定と変換
- **F012**: 重複コンテンツの検出と除去
- **F013**: テキストの正規化（空白、改行の整理）
- **F014**: 不要なコンテンツの除去（広告、ナビゲーション等）

#### 2.1.4 Dify向けナレッジファイル生成機能
- **F015**: 収集したテキストをDify最適化形式で構造化
- **F016**: Difyで認識しやすいメタデータの付与（タイトル、URL、日時）
- **F017**: テキストの適切な分割（Difyのチャンク処理に最適化）
- **F018**: ファイルサイズ制限の考慮（Difyの制限内に収める）
- **F019**: 関連コンテンツの適切なグループ化

### 2.2 Dify固有機能

#### 2.2.1 Dify互換性機能
- **F020**: Difyサポート形式でのファイル出力（.txt、.md、.docx）
- **F021**: Difyのトークン制限を考慮したファイル分割
- **F022**: Difyでの検索精度向上のためのキーワード埋め込み
- **F023**: Difyチャンク単位での論理的な内容分割

#### 2.2.2 品質管理機能
- **F024**: Difyでの読み込み品質検証
- **F025**: 重複内容の除去とマージ
- **F026**: テキストの可読性向上処理
- **F027**: 適切な文書構造の生成（見出し、段落の整理）

### 2.3 出力機能

#### 2.3.1 Dify向けファイル出力
- **F028**: テキストファイル形式（.txt）での出力
- **F029**: Markdown形式（.md）での出力
- **F030**: Word文書形式（.docx）での出力
- **F031**: ファイル名の自動生成（サイト名+日時）
- **F032**: 複数ファイルへの自動分割（サイズ制限対応）

#### 2.3.2 レポート機能
- **F033**: スクレイピング実行結果の概要レポート
- **F034**: Dify用ファイル生成結果の統計
- **F035**: エラーログとスキップされたページの一覧
- **F036**: Difyでの活用に関する推奨事項レポート

### 2.4 設定・管理機能

#### 2.4.1 設定機能
- **F037**: 設定ファイル（config.json）による動作設定
- **F038**: Dify向け出力設定（ファイル形式、分割サイズ等）
- **F039**: 除外URL/パターンの設定機能
- **F040**: ユーザーエージェントの設定機能

#### 2.4.2 ログ機能
- **F041**: 実行ログの出力
- **F042**: エラーログの詳細記録
- **F043**: 進捗状況の表示

## 3. 非機能要件

### 3.1 性能要件
- **NF001**: 1ページあたりの処理時間は平均3秒以内
- **NF002**: 同時実行可能なリクエスト数は設定可能（デフォルト3）
- **NF003**: メモリ使用量は1GB以下で動作
- **NF004**: 1000ページのスクレイピングを2時間以内で完了
- **NF005**: Dify向けファイル生成時間は1分以内（100ページ分）

### 3.2 Dify互換性要件
- **NF006**: Difyファイルサイズ制限の遵守（15MB以下/ファイル）
- **NF007**: Difyでの読み込み成功率95%以上
- **NF008**: 適切なチャンク分割による検索精度向上
- **NF009**: Difyトークン制限への配慮

### 3.3 信頼性要件
- **NF010**: ネットワークエラーに対する自動リトライ機能（最大3回）
- **NF011**: 一時的な障害によるプロセス中断からの復旧機能
- **NF012**: 不正なHTMLに対する堅牢な処理
- **NF013**: Difyファイル形式の検証機能

### 3.4 使用性要件
- **NF014**: コマンドライン実行でのシンプルな操作
- **NF015**: 設定ファイルでの詳細カスタマイズ可能
- **NF016**: 実行中の進捗状況の視覚的表示
- **NF017**: Dify用ファイルの品質確認機能

### 3.5 セキュリティ要件
- **NF018**: 認証が必要なサイトへの対応（Basic認証）
- **NF019**: SSL/TLS証明書の検証
- **NF020**: 悪意のあるサイトからの保護

### 3.6 互換性要件
- **NF021**: Python 3.8以上での動作
- **NF022**: 主要なOS（Windows、macOS、Linux）での動作
- **NF023**: 主要なWebブラウザのUser-Agent対応
- **NF024**: Dify最新版との互換性維持

## 4. 技術要件

### 4.1 使用技術
- **言語**: Python 3.8+
- **主要ライブラリ**:
  - requests: HTTP通信
  - BeautifulSoup4: HTML解析
  - scrapy: スクレイピングフレームワーク（オプション）
  - urllib: URL処理
  - markdown: Markdown生成
  - python-docx: Word文書生成
  - tiktoken: トークン数計算（Dify互換）
  - logging: ログ機能
  - concurrent.futures: 並列処理
  - time: 待機制御

### 4.2 アーキテクチャ
- **設計パターン**: MVC（Model-View-Controller）
- **モジュール構成**:
  - scraper: スクレイピング機能
  - parser: テキスト解析機能
  - dify_generator: Dify向けファイル生成機能
  - file_formatter: ファイル形式変換機能
  - config: 設定管理機能
  - utils: ユーティリティ機能

## 5. システム構成

### 5.1 入力仕様
```
python main.py --url <URL> --depth <深度> --max-pages <最大ページ数> [オプション]
```

**必須パラメータ**:
- `--url`: 開始URL
- `--depth`: クロール深度（1-10）
- `--max-pages`: 最大取得ページ数（1-1000）

**オプションパラメータ**:
- `--output-format`: 出力形式（txt/md/docx/all）
- `--output-dir`: 出力ディレクトリ
- `--config`: 設定ファイルパス
- `--delay`: リクエスト間隔（秒）
- `--concurrent`: 同時リクエスト数
- `--max-file-size`: ファイル最大サイズ（MB）
- `--chunk-size`: チャンクサイズ（文字数）

### 5.2 出力仕様

#### 5.2.1 テキストファイル形式（.txt）
```
サイト名: https://example.com
取得日時: 2024-06-24 10:30:00
総ページ数: 85
=================================

【ページタイトル1】
URL: https://example.com/page1
取得日時: 2024-06-24 10:30:15

本文内容がここに続く...
文章は適切な改行と段落で整理されている。

=================================

【ページタイトル2】
URL: https://example.com/page2
取得日時: 2024-06-24 10:30:30

次のページの内容...
```

#### 5.2.2 Markdown形式（.md）
```markdown
# サイト名: https://example.com

**取得日時**: 2024-06-24 10:30:00  
**総ページ数**: 85

---

## ページタイトル1

**URL**: https://example.com/page1  
**取得日時**: 2024-06-24 10:30:15

本文内容がここに続く...

---

## ページタイトル2

**URL**: https://example.com/page2  
**取得日時**: 2024-06-24 10:30:30

次のページの内容...
```

#### 5.2.3 Word文書形式（.docx）
- 構造化された見出し
- 適切なフォーマット（太字、リンク等）
- 目次の自動生成
- ページ区切りの適切な配置

## 6. 制約事項

### 6.1 技術的制約
- **C001**: JavaScript動的コンテンツは対象外（静的HTMLのみ）
- **C002**: 認証が必要なページは基本認証のみ対応
- **C003**: 大容量ファイル（画像、動画等）は処理対象外
- **C004**: Difyファイルサイズ制限（15MB/ファイル）の遵守
- **C005**: Difyでサポートされる文字エンコーディング（UTF-8）

### 6.2 Dify制約
- **C006**: ファイル形式制限（.txt、.md、.docx のみ）
- **C007**: トークン数制限への配慮
- **C008**: ファイル数制限（実用的な範囲内）
- **C009**: 特殊文字やフォーマットの制限

### 6.3 法的・倫理的制約
- **C010**: robots.txtの遵守
- **C011**: 利用規約の確認が必要
- **C012**: 著作権保護コンテンツの適切な取り扱い
- **C013**: 個人情報の収集回避

### 6.4 運用制約
- **C014**: サーバーへの過度な負荷を避けるためのリクエスト制限
- **C015**: 1日あたりの実行回数制限（同一サイト）
- **C016**: Difyでの利用用途に限定

## 7. 開発・運用要件

### 7.1 開発環境
- Python 3.8+
- 仮想環境（venv/conda）
- Git バージョン管理
- pytest テストフレームワーク

### 7.2 配布・インストール
- pip installable package
- requirements.txt による依存関係管理
- Docker対応（オプション）
- Dify用ファイル生成に特化した設定例

### 7.3 ドキュメント
- README.md: インストール・使用方法
- DIFY_INTEGRATION.md: Difyとの連携方法
- 設定ファイル例
- Dify用ファイル品質ガイド
- トラブルシューティングガイド

## 8. テスト要件

### 8.1 単体テスト
- 各モジュールの機能テスト
- Difyファイル生成機能テスト
- エラーハンドリングテスト
- 境界値テスト（ファイルサイズ、文字数等）

### 8.2 統合テスト
- エンドツーエンドテスト
- 実際のWebサイトでの動作テスト
- Difyでの読み込みテスト
- 大量データでの性能テスト

### 8.3 Dify互換性テスト
- 生成ファイルのDify読み込み確認
- 検索機能の精度テスト
- ファイル形式別の動作確認
- 文字エンコーディングテスト

### 8.4 テストデータ
- テスト用HTML ファイル
- モックWebサーバー
- Dify用サンプルファイル
- 各種エラーケースのシミュレーション

## 9. リスク分析

### 9.1 技術的リスク
- **R001**: 対象サイトの構造変更によるスクレイピング失敗
- **R002**: 大量データ処理時のメモリ不足
- **R003**: ネットワーク不安定による処理中断
- **R004**: Difyの仕様変更による互換性問題
- **R005**: ファイル形式変換時の品質劣化

### 9.2 Dify関連リスク
- **R006**: Difyの制限変更によるファイル読み込み失敗
- **R007**: 大容量ファイルによるDify性能低下
- **R008**: 文字エンコーディング問題によるデータ破損

### 9.3 法的リスク
- **R009**: サイト利用規約違反
- **R010**: 著作権侵害
- **R011**: 個人情報保護法違反

### 9.4 運用リスク
- **R012**: サーバーからのアクセス制限
- **R013**: IPアドレスのブロック
- **R014**: 大量リクエストによるサーバーダウン
- **R015**: Dify利用者の不適切な使用

## 10. スケジュール

### Phase 1: 基本機能開発（2週間）
- 基本スクレイピング機能
- テキスト抽出機能
- 設定管理機能
- 基本的なDifyファイル生成機能

### Phase 2: Dify最適化機能開発（2週間）
- 深度制御機能
- 並列処理機能
- Dify向け出力形式対応（.txt、.md、.docx）
- ファイル分割・統合機能

### Phase 3: 品質向上・テスト（1週間）
- 単体テスト実装
- Dify互換性テスト
- 統合テスト実行
- バグ修正

### Phase 4: ドキュメント・リリース（1週間）
- ドキュメント作成
- Dify連携ガイド作成
- パッケージング
- リリース準備

## 11. 成果物

### 11.1 ソースコード
- main.py: メインプログラム
- scraper/: スクレイピング機能モジュール
- parser/: テキスト解析モジュール
- dify_generator/: Dify向けファイル生成モジュール
- file_formatter/: ファイル形式変換モジュール
- config/: 設定管理モジュール
- tests/: テストコード

### 11.2 設定ファイル
- config.json: 基本設定
- dify_config.json: Dify向け設定
- requirements.txt: 依存関係
- setup.py: パッケージ設定

### 11.3 ドキュメント
- README.md: 使用方法
- DIFY_INTEGRATION.md: Dify連携ガイド
- FILE_FORMAT_GUIDE.md: ファイル形式ガイド
- TROUBLESHOOTING.md: トラブルシューティング
- CHANGELOG.md: 変更履歴

### 11.4 サンプルファイル
- sample_config.json: 設定ファイル例
- sample_output.txt: テキスト出力例
- sample_output.md: Markdown出力例
- sample_output.docx: Word文書出力例

---

**作成日**: 2025年6月24日  
**作成者**: GitHub Copilot  
**バージョン**: 2.0 (Dify対応版)  
**更新内容**: Difyナレッジベース対応への全面改訂