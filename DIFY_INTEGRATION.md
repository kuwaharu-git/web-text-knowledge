# Dify連携ガイド

## 概要

このガイドでは、生成されたナレッジファイルをDifyに取り込み、効果的に活用する方法について説明します。

## 生成ファイルの準備

### 1. ファイル形式の選択

Difyでサポートされる形式：
- **テキストファイル (.txt)**: 最もシンプルで確実
- **Markdownファイル (.md)**: 構造化された情報に最適
- **Word文書 (.docx)**: リッチフォーマット情報を保持

**推奨**: 初回の利用では`.txt`形式から始めることをお勧めします。

### 2. ファイルサイズの確認

- Difyの制限: **15MB以下/ファイル**
- 本システムは自動的にこの制限を遵守するようファイルを分割します
- 大量のページをスクレイピングした場合、複数のファイルに分割されます

## Difyでの設定手順

### ステップ1: ナレッジベースの作成

1. Difyダッシュボードにログイン
2. 左サイドバーの「ナレッジベース」をクリック
3. 「新しいナレッジベースを作成」をクリック
4. 名前と説明を入力（例：「◯◯サイト情報」）

### ステップ2: ファイルのアップロード

1. 作成したナレッジベースを開く
2. 「ファイルをアップロード」をクリック
3. 生成されたファイルを選択してアップロード
4. アップロード完了まで待機

### ステップ3: インデックス設定の最適化

#### チャンク設定
- **チャンクサイズ**: 500-800文字を推奨
- **オーバーラップ**: 50-100文字を推奨

#### ベクトル化設定
- **埋め込みモデル**: OpenAI Text Embedding Ada 002 を推奨
- **類似度しきい値**: 0.7-0.8 を推奨

### ステップ4: ナレッジベースの検証

1. 「テスト」機能を使用してサンプル質問を実行
2. 適切な情報が取得できるか確認
3. 必要に応じてチャンク設定を調整

## 効果的な活用方法

### 1. 検索精度の向上

#### キーワードの最適化
- 生成ファイルには重要なキーワードが自動的に埋め込まれています
- 質問時は具体的なキーワードを含めることで精度が向上します

#### 質問例（良い例）
```
- 「商品の価格について教えて」
- 「配送方法の詳細を知りたい」
- 「サポート連絡先を教えて」
```

#### 質問例（改善が必要）
```
- 「これについて教えて」
- 「詳細は？」
- 「どうなってる？」
```

### 2. アプリケーションでの利用

#### チャットボット設定
1. 「アプリ」→「新しいアプリを作成」→「チャットアシスタント」
2. ナレッジベースを関連付け
3. プロンプトでコンテキストを設定

#### サンプルプロンプト
```
あなたは{サイト名}の専門アシスタントです。
提供されたナレッジベースの情報を基に、ユーザーの質問に正確かつ親切に回答してください。

回答時の注意点：
- 情報が見つからない場合は正直にその旨を伝える
- 推測ではなく、ナレッジベース内の正確な情報のみを使用する
- 回答には情報の出典（URL）を含める
```

### 3. 定期的な更新

#### 更新のタイミング
- ウェブサイトの大幅な変更時
- 新しい情報が追加された時
- 月1回程度の定期更新

#### 更新手順
1. 最新の情報で再スクレイピング実行
2. 古いファイルを削除
3. 新しいファイルをアップロード
4. インデックスの再構築を実行

## トラブルシューティング

### ファイルがアップロードできない

**問題**: ファイルサイズが大きすぎる
**解決策**: `--max-file-size`オプションでサイズを小さく設定

**問題**: ファイル形式がサポートされていない
**解決策**: `.txt`、`.md`、`.docx`のいずれかの形式を使用

### 検索結果が期待通りでない

**問題**: 関連性の低い情報が返される
**解決策**: 
- チャンクサイズを小さくする（300-500文字）
- 類似度しきい値を高くする（0.8-0.9）

**問題**: 情報が見つからない
**解決策**:
- より具体的なキーワードで質問
- スクレイピング時の除外パターンを確認

### パフォーマンスが遅い

**問題**: ナレッジベースが大きすぎる
**解決策**:
- 不要な情報を除外するよう設定を調整
- 複数の小さなナレッジベースに分割

## ベストプラクティス

### 1. ファイル命名規則
```
{サイト名}_{取得日時}_{内容種別}
例: company_20240624_product_info.txt
```

### 2. メタデータの活用
- 生成ファイルに含まれるURL情報を活用
- 情報の鮮度を定期的にチェック

### 3. 品質管理
- 定期的にテストクエリを実行
- ユーザーフィードバックを収集
- 必要に応じて除外パターンを追加

### 4. セキュリティ考慮事項
- 機密情報が含まれていないか確認
- アクセス権限を適切に設定
- 定期的な監査を実施

## FAQ

**Q: どのくらいの頻度で更新すべきですか？**
A: サイトの更新頻度にもよりますが、月1回程度の更新を推奨します。

**Q: 複数のサイトの情報を1つのナレッジベースにまとめられますか？**
A: 可能ですが、サイト別に分けた方が検索精度が向上します。

**Q: 生成したファイルを編集しても問題ありませんか？**
A: 問題ありませんが、次回の自動更新時に上書きされる可能性があります。

**Q: エラーが発生してスクレイピングが途中で止まります**
A: `--delay`オプションでリクエスト間隔を長くし、サーバーへの負荷を軽減してください。

---

**更新日**: 2025年6月24日  
**対象バージョン**: Difyナレッジファイル生成システム v2.0
